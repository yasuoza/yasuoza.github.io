<!doctype html><html><head><meta charset=utf-8><base href=https://yasuoza.github.io><title>Goのerrgroupとセマフォを組み合わせるメモ</title><link rel=canonical href=https://yasuoza.github.io/2020/09/04/go-errorgroup-with-semaphore/><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://yasuoza.github.ioindex.xml title="Back of the flyer"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/singular.min.f674f27296b832877918f696aa1fe38716960e60a0f6e8be2d645e0ad19ad39b.css integrity="sha256-9nTycpa4Mod5GPaWqh/jhxaWDmCg9ui+LWReCtGa05s=" crossorigin=anonymous media=screen><link href="https://fonts.googleapis.com/css?family=Open+Sans%3A400%2C400i%2C700%2C700i%2C800%2C800i&subset=latin%2Clatin-ext" rel=stylesheet><link rel=stylesheet href=/css/custom.css media=screen><link rel=stylesheet href=/css/amazon.min.d5af53f3a8ee79e459a775825b59f0dcfbc64cc63c5b69dc71ef303a15d6c8fc.css integrity="sha256-1a9T86jueeRZp3WCW1nw3PvGTMY8W2ncce8wOhXWyPw=" crossorigin=anonymous media=screen></head><body><header id=masthead class=site-header><div class="site-header__branding site-branding"><div class="site-branding__logo site-logo site-logo--rounded"><a class=custom-logo-link rel=home itemprop=url href><img width=96 height=96 src=/images/icon.jpg></a></div><div class=site-branding__copy><h1 class=site-title><a href=/ rel=home>Back of the flyer</a></h1><p class=site-description>Daily life and memos</p></div></div></header><div class="site-main content"><article><header class=entry-header><h1 class=entry-title>Goのerrgroupとセマフォを組み合わせるメモ</h1></header><div class="entry-meta entry-meta-before-content"><span class="entry-meta-item posted-on"><a href=https://yasuoza.github.io/2020/09/04/go-errorgroup-with-semaphore/><time class="entry-date published" datetime=2020-09-04T05:11:02+0000>September 4, 2020</time></a></span></div><div class=entry-content><p>Goの並列処理でセマフォを利用しつつ、<a href=https://pkg.go.dev/golang.org/x/sync/errgroup><code>errgroup</code></a>を利用したエラー処理をしたい場面があったので、そのメモ。</p><p>バッチ処理で一定数を並列に処理したいのだけど、どこかのバッチで失敗した場合にそれ以降のバッチはすべて行わないようにしたい。</p><p>たとえば、次のパターン。</p><ul><li><code>[0, 1, 2]</code></li><li><code>[3, 4, 5]</code></li><li><code>[6, 7, 8]</code></li></ul><p>この組み合わせでこの順に処理が3並列で行われるケースを考える。1つめのバッチでは<code>[0, 1, 2]</code>を並列処理し、2つめのバッチでは<code>[3, 4, 5]</code>を並列処理するというものだ。<br>このどこかのバッチ処理でエラーが発生した場合には後続のバッチ処理を行わないようにしたい。</p><p>次のサンプルコードでは2個めのバッチ処理(<code>[3, 4, 5]</code>)でエラーを発生させ、3個めのバッチ処理では処理を行わないようにしたい。そこで、<code>errgroup.WithContext</code>を利用して、他のgoroutineのエラーをチェックを行なっている。<br>なお、今回の処理ではセマフォの重み付けが不要だったので、<a href=https://pkg.go.dev/golang.org/x/sync/semaphore><code>sync.semaphore</code></a>ではなく<code>channel</code>を利用した簡易的なものを使っている。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#000;font-weight:700>package</span> main

<span style=color:#000;font-weight:700>import</span> (
	<span style=color:#d14>&#34;context&#34;</span>
	<span style=color:#d14>&#34;errors&#34;</span>
	<span style=color:#d14>&#34;fmt&#34;</span>
	<span style=color:#d14>&#34;time&#34;</span>

	<span style=color:#d14>&#34;golang.org/x/sync/errgroup&#34;</span>
)

<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>heavyTask</span>(i <span style=color:#458;font-weight:700>int</span>) <span style=color:#458;font-weight:700>error</span> {
	<span style=color:#000;font-weight:700>const</span> tg = <span style=color:#099>5</span>
	<span style=color:#000;font-weight:700>if</span> i <span style=color:#000;font-weight:700>==</span> tg { <span style=color:#998;font-style:italic>// fake error
</span><span style=color:#998;font-style:italic></span>		msg <span style=color:#000;font-weight:700>:=</span> fmt.<span style=color:#900;font-weight:700>Sprintf</span>(<span style=color:#d14>&#34;%d is not acceptable&#34;</span>, i)
		fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;%s. we&#39;re failing\n&#34;</span>, msg)
		<span style=color:#000;font-weight:700>return</span> errors.<span style=color:#900;font-weight:700>New</span>(msg)
	}
	fmt.<span style=color:#900;font-weight:700>Println</span>(i)
	time.<span style=color:#900;font-weight:700>Sleep</span>(<span style=color:#099>2</span> <span style=color:#000;font-weight:700>*</span> time.Second)
	<span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>nil</span>
}

<span style=color:#000;font-weight:700>func</span> <span style=color:#900;font-weight:700>main</span>() {
	<span style=color:#998;font-style:italic>// cheap semaphore implementation
</span><span style=color:#998;font-style:italic></span>	sem <span style=color:#000;font-weight:700>:=</span> <span style=color:#0086b3>make</span>(<span style=color:#000;font-weight:700>chan</span> <span style=color:#458;font-weight:700>bool</span>, <span style=color:#099>3</span>)

	g, ctx <span style=color:#000;font-weight:700>:=</span> errgroup.<span style=color:#900;font-weight:700>WithContext</span>(context.<span style=color:#900;font-weight:700>Background</span>())
	<span style=color:#000;font-weight:700>for</span> i <span style=color:#000;font-weight:700>:=</span> <span style=color:#099>0</span>; i &lt; <span style=color:#099>10</span>; i<span style=color:#000;font-weight:700>++</span> {
		sem <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#000;font-weight:700>true</span>

		<span style=color:#998;font-style:italic>// Capture `i` variable to use go func
</span><span style=color:#998;font-style:italic></span>		i <span style=color:#000;font-weight:700>:=</span> i
		g.<span style=color:#900;font-weight:700>Go</span>(<span style=color:#000;font-weight:700>func</span>() <span style=color:#458;font-weight:700>error</span> {
			<span style=color:#000;font-weight:700>defer</span> <span style=color:#000;font-weight:700>func</span>() { <span style=color:#000;font-weight:700>&lt;-</span>sem }()
			<span style=color:#000;font-weight:700>select</span> {
			<span style=color:#000;font-weight:700>case</span> <span style=color:#000;font-weight:700>&lt;-</span>ctx.<span style=color:#900;font-weight:700>Done</span>():
				<span style=color:#998;font-style:italic>// groutine started.
</span><span style=color:#998;font-style:italic></span>				<span style=color:#998;font-style:italic>// But the context is set Done by another goroutine returned error.
</span><span style=color:#998;font-style:italic></span>				<span style=color:#998;font-style:italic>// So we do not execute heavyTask.
</span><span style=color:#998;font-style:italic></span>				fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;canceled %d\n&#34;</span>, i)
				<span style=color:#000;font-weight:700>return</span> ctx.<span style=color:#900;font-weight:700>Err</span>()
			<span style=color:#000;font-weight:700>default</span>:
				<span style=color:#000;font-weight:700>return</span> <span style=color:#900;font-weight:700>heavyTask</span>(i)
			}
		})
	}

	<span style=color:#000;font-weight:700>if</span> err <span style=color:#000;font-weight:700>:=</span> g.<span style=color:#900;font-weight:700>Wait</span>(); err <span style=color:#000;font-weight:700>!=</span> <span style=color:#000;font-weight:700>nil</span> {
		fmt.<span style=color:#900;font-weight:700>Printf</span>(<span style=color:#d14>&#34;Fatal: %v\n&#34;</span>, err)
	}
}
</code></pre></div><p>実行結果の例は次のようなかんじ。<code>[7, 8, 9]</code>のバッチは完全にキャンセルされている。<br>goroutineの実行タイミングで数字の順番がすこし変わったりはする。</p><pre><code>2
0
1
3
5 is not acceptable. we're failing
4
canceled 6
canceled 7
canceled 8
canceled 9
Fatal: 5 is not acceptable
</code></pre><p>日常的に多く使うものではないけれど、goroutineとエラー処理を考えるいい例なのかなと思ったりした。</p><hr><h2 id=refereneces>Refereneces</h2><ul><li><a href=https://pkg.go.dev/golang.org/x/sync/errgroup>https://pkg.go.dev/golang.org/x/sync/errgroup</a></li></ul></div><nav class="navigation post-navigation" role=navigation aria-label="Posts navigation"><h2 class=screen-reader-text>Posts navigation</h2><div class=nav-links><div class=nav-nxt><span>Newer Post</span>
<a href=https://yasuoza.github.io/2020/09/10/vim-tagjump-based-on-filetype/ rel=next>vimでファイルタイプに基づいたTagジャンプを行う</a></div><div class=nav-pre><span>Older Post</span>
<a href=https://yasuoza.github.io/2020/08/27/blogging-from-dockernized-code-server/ rel=prev>Code ServerとiPadでブログを書く</a></div></div></nav></article></div><footer id=colophon class=site-footer role=contentinfo><div class="site-footer__copy site-copy"></div></footer></body></html>