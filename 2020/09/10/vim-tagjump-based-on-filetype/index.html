<!doctype html><html><head><meta charset=utf-8><base href=https://yasuoza.github.io><title>vimでファイルタイプに基づいたTagジャンプを行う</title><link rel=canonical href=https://yasuoza.github.io/2020/09/10/vim-tagjump-based-on-filetype/><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://yasuoza.github.ioindex.xml title="Back of the flyer"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/singular.min.d66b189356bc7c8538e0f6ee089f3ecc36d40b8b01f577b69d883d00123ad7ad.css integrity="sha256-1msYk1a8fIU44PbuCJ8+zDbUC4sB9Xe2nYg9ABI6160=" crossorigin=anonymous media=screen><link href="https://fonts.googleapis.com/css?family=Open+Sans%3A400%2C400i%2C700%2C700i%2C800%2C800i&subset=latin%2Clatin-ext" rel=stylesheet><link rel=stylesheet href=/css/custom.css media=screen><link rel=stylesheet href=/css/amazon.min.d5af53f3a8ee79e459a775825b59f0dcfbc64cc63c5b69dc71ef303a15d6c8fc.css integrity="sha256-1a9T86jueeRZp3WCW1nw3PvGTMY8W2ncce8wOhXWyPw=" crossorigin=anonymous media=screen></head><body><header id=masthead class=site-header><div class="site-header__branding site-branding"><div class="site-branding__logo site-logo site-logo--rounded"><a class=custom-logo-link rel=home itemprop=url href><img width=96 height=96 src=/images/icon.jpg></a></div><div class=site-branding__copy><h1 class=site-title><a href=/ rel=home>Back of the flyer</a></h1><p class=site-description>Daily life and memos</p></div></div></header><div class="site-main content"><article><header class=entry-header><h1 class=entry-title>vimでファイルタイプに基づいたTagジャンプを行う</h1></header><div class="entry-meta entry-meta-before-content"><span class="entry-meta-item posted-on"><a href=https://yasuoza.github.io/2020/09/10/vim-tagjump-based-on-filetype/><time class="entry-date published" datetime=2020-09-10T10:14:15+0000>September 10, 2020</time></a></span></div><div class=entry-content><p>基本的に普段はvimを使った開発をしていて、コードの補完やタグジャンプには<a href=https://github.com/neoclide/coc.nvim>coc.nvim</a>を利用している。<br>TypeScript(JavaScript)やGoのタグジャンプはcoc.nvimとエクステンションを利用することでうまく行うことができる。だが、<a href=https://github.com/castwide/solargraph>solargraph</a>を利用しているRubyではうまくタグジャンプできず、地味に困っていた。</p><p>coc.nvimを導入する前は、<a href=https://github.com/tmm1/ripper-tags>ripper-tags</a>でtagsファイルを事前に作成しておき、それを利用してvimデフォルトのタグジャンプ <code>:tag</code> を行っていた。ここ最近うまくタグジャンプできず不便なシーンが多発したので、solargraphのlspとripper-tagsのtagsファイルとでタグジャンプを比較してみた。その結果、圧倒的にripper-tagsを利用したtagsファイルに基づくタグジャンプのほうが正しくジャンプできた。</p><p>そのため、方針としては次の通りとした。</p><ul><li>vimで開いているbufferがRubyの場合は <code>tags</code> ファイルが存在すればタグジャンプに <code>:tag</code> を利用</li><li>bufferがRubyでも <code>tags</code> ファイルが存在していなければcoc.nvimの <code>CocAction('jumpDefinition')</code> を利用</li><li>Ruby以外はcoc.nvimの <code>CocAction('jumpDefinition')</code> を利用</li></ul><p>で、コードは次の通り。これで、<code>Ctrl-]</code>でタグジャンプができる。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#000;font-weight:700>function</span>! s:jump_definition()<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  <span style=color:#000;font-weight:700>let</span> tags_file = findfile(<span style=color:#d14>&#39;tags&#39;</span>, expand(<span style=color:#d14>&#39;%:p:h&#39;</span>).<span style=color:#d14>&#39;;&#39;</span>.$HOME, <span style=color:#099>1</span>)<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  <span style=color:#000;font-weight:700>if</span> &amp;filetype == <span style=color:#d14>&#39;ruby&#39;</span> &amp;&amp; filereadable(expand(tags_file))<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    execute <span style=color:#d14>&#39;tag &#39;</span>.RubyCursorTag()<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  <span style=color:#000;font-weight:700>else</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>    call CocAction(<span style=color:#d14>&#39;jumpDefinition&#39;</span>)<span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>  <span style=color:#000;font-weight:700>endif</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span><span style=color:#000;font-weight:700>endfunction</span><span style=color:#a61717;background-color:#e3d2d2>
</span><span style=color:#a61717;background-color:#e3d2d2></span>nmap &lt;silent&gt; &lt;C-]&gt; :call &lt;SID&gt;jump_definition()&lt;CR&gt;<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div><p>ポイントとしては <code>tags</code> ファイルの検索に制限を設ける点。システムルートまでたどるのではなく、今回はホームフォルダまで検索するようにした。<br>ホームフォルダより上のディレクトリで作業するというのもほとんどないので今はこれで十分。<br>もしルートディレクトリまで検索したい場合は、次のようにすればOK。</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vim data-lang=vim><span style=color:#000;font-weight:700>let</span> tags_file = findfile(<span style=color:#d14>&#39;tags&#39;</span>, expand(<span style=color:#d14>&#39;%:p:h&#39;</span>).<span style=color:#d14>&#39;;/&#39;</span>, <span style=color:#099>1</span>)<span style=color:#a61717;background-color:#e3d2d2>
</span></code></pre></div></div><nav class="navigation post-navigation" role=navigation aria-label="Posts navigation"><h2 class=screen-reader-text>Posts navigation</h2><div class=nav-links><div class=nav-nxt><span>Newer Post</span>
<a href=https://yasuoza.github.io/2020/10/07/github-codespaces-beta/ rel=next>Github CodespacesのBeta招待が来た</a></div><div class=nav-pre><span>Older Post</span>
<a href=https://yasuoza.github.io/2020/09/04/go-errorgroup-with-semaphore/ rel=prev>Goのerrgroupとセマフォを組み合わせるメモ</a></div></div></nav></article></div><footer id=colophon class=site-footer role=contentinfo><div class="site-footer__copy site-copy"></div></footer></body></html>