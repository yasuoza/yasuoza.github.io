<!doctype html><html><head><meta charset=utf-8><base href=https://yasuoza.github.io><title>GoでSwitchBotを操作する</title><link rel=canonical href=https://yasuoza.github.io/2020/08/18/switchbot-go/><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://yasuoza.github.ioindex.xml title="Back of the flyer"><link rel=icon type=image/x-icon href=/favicon.ico><link rel=stylesheet href=/css/singular.min.302db4a9da8420576fd3bd629c76a5baf9e396f6c633a357a96233b8ca20fe60.css integrity="sha256-MC20qdqEIFdv071inHaluvnjlvbGM6NXqWIzuMog/mA=" crossorigin=anonymous media=screen><link href="https://fonts.googleapis.com/css?family=Open+Sans%3A400%2C400i%2C700%2C700i%2C800%2C800i&subset=latin%2Clatin-ext" rel=stylesheet><link rel=stylesheet href=/css/custom.css media=screen><link rel=stylesheet href=/css/amazon.min.d5af53f3a8ee79e459a775825b59f0dcfbc64cc63c5b69dc71ef303a15d6c8fc.css integrity="sha256-1a9T86jueeRZp3WCW1nw3PvGTMY8W2ncce8wOhXWyPw=" crossorigin=anonymous media=screen></head><body><header id=masthead class=site-header><div class="site-header__branding site-branding"><div class="site-branding__logo site-logo site-logo--rounded"><a class=custom-logo-link rel=home itemprop=url href><img width=96 height=96 src=/images/icon.jpg></a></div><div class=site-branding__copy><h1 class=site-title><a href=/ rel=home>Back of the flyer</a></h1><p class=site-description>Daily life and memos</p></div></div></header><div class="site-main content"><article><header class=entry-header><h1 class=entry-title>GoでSwitchBotを操作する</h1></header><div class="entry-meta entry-meta-before-content"><span class="entry-meta-item posted-on"><a href=https://yasuoza.github.io/2020/08/18/switchbot-go/><time class="entry-date published" datetime=2020-08-18T12:09:11+0000>August 18, 2020</time></a></span></div><div class=entry-content><p>我が家ではホームIoTを自作していて、HomeKitやAlexaを駆使してエアコンを操作したり、テレビや照明を操作したりしている。<br>その中でも最も家族に評価されているのがお風呂の自動化だ。</p><p>お風呂を入れるにはお風呂場に行って換気扇を一時的に止め、それと同時にお湯を入れるスイッチを押す必要があるのだが、お風呂を入れるタイミングはだいたい家族で団らんしていたり、ゆっくりしているときなので、誰も立ち上がりたくなく、お風呂を入れるときにいつも小さなせめぎ合い起きていた。</p><p>この問題を解消するため、我が家では</p><ul><li>お風呂の換気扇のスイッチを押し、換気扇を一時的に止める。</li><li>お湯を入れるスイッチを押す。</li></ul><p>という2つのスイッチ操作を</p><div class=amazon-widget><a target=_blank href="https://www.amazon.co.jp/gp/product/B07B7NXV4R/?tag=yasuoza-22"></a><div class=amazon-widget-img><img src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=JP&ASIN=B07B7NXV4R&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL350_&tag=yasuoza-22"></div><div class=amazon-widget-info><span class=amazon-widget-title>SwitchBot ボット スイッチ ボタンに適用 指ロボット スマートホーム ワイヤレス タイマー スマホで遠隔操作 アレクサ、Google home、HomePod、IFTTTに対応(ハブ必要)</span>
<span class=amazon-widget-via><img src=https://www.amazon.co.jp/favicon.ico>
amazon.co.jp</span></div></div><p>を2つ利用して実現している。</p><p>このSwitchBotを操作するには</p><ul><li>スマートフォンアプリを都度開いて操作する。</li><li>SwitchBot Hubを別途購入してAlexaやIFTTTと連携して操作する。</li><li>操作するコードを書いて操作する。</li></ul><p>がある。</p><p>AlexaだけであればSwitchBot Hubを購入する方法が楽だが、<a href=https://nodered.org/>Node-Red</a>を利用したHomeKit連携も作り込んでおり、Homeアプリ対応もしたかったので結局自分でコードを書くことにした。<br>ちなみに、このSwitchBotはBluetoothで操作することができ、<a href=https://github.com/OpenWonderLabs/python-host>公式のサンプルコード</a>が公開されているのでそれが参考になる。<br>他にもサードパーティの<a href=https://github.com/RoButton/switchbotpy>RoButton/switchbotpy</a>が公開されており、これがとても参考になった。</p><p>Goを選んだのはクロスコンパイルがあってホームIoTの母艦となっているRaspberry Pi Zero W向けにバイナリを出力できるから。他にもクロスコンパイルできる言語はあるけど、BLEのライブラリもある程度選べるGoを選択した。<br>リリース時のバイナリ生成もGitHub Actionsと<a href=https://goreleaser.com/>GoReleaser</a>を利用して、ビルドの方法を忘れても良いような設定にした。</p><p>というわけで成果物はこちら。</p><div class=gh-card><a href=https://github.com/yasuoza/switchbot><img src="https://gh-card.dev/repos/yasuoza/switchbot.svg?fullname="></a></div><p>Raspberry Pi Zero W(ARM 6)で使う場合は</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -SL https://github.com/yasuoza/switchbot/releases/latest/download/switchbot_linux_armv6.tar.gz -O
tar -xvzf switchbot_linux_armv6.tar.gz

<span style=color:#998;font-style:italic># sudoなしでswitchbotを実行する場合</span>
sudo setcap <span style=color:#d14>&#39;cap_net_raw,cap_net_admin+eip&#39;</span> ./switchbot
</code></pre></div><p>で利用できる。</p></div><nav class="navigation post-navigation" role=navigation aria-label="Posts navigation"><h2 class=screen-reader-text>Posts navigation</h2><div class=nav-links><div class=nav-nxt><span>Newer Post</span>
<a href=https://yasuoza.github.io/2020/08/27/blogging-from-dockernized-code-server/ rel=next>Code ServerとiPadでブログを書く</a></div><div class=nav-pre><span>Older Post</span>
<a href=https://yasuoza.github.io/2020/08/09/helloworld/ rel=prev>Hello World</a></div></div></nav></article></div><footer id=colophon class=site-footer role=contentinfo><div class="site-footer__copy site-copy"></div></footer></body></html>